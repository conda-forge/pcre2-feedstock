--- CMakeLists.txt	2019-10-01 18:19:12.000000000 +0200
+++ CMakeLists.txt	2020-04-20 10:16:54.000000000 +0200
@@ -400,12 +400,12 @@
   LIMIT_COUNT 50 # Read only the first 50 lines of the file
 )
 
-set(SEARCHED_VARIABLES "pcre2_major" "pcre2_minor" "pcre2_prerelease" "pcre2_date")
+set(SEARCHED_VARIABLES "pcre2_major" "pcre2_minor" "pcre2_prerelease" "pcre2_date" "libpcre2_8_version" "libpcre2_posix_version")
 foreach(configure_line ${configure_lines})
     foreach(_substitution_variable ${SEARCHED_VARIABLES})
         string(TOUPPER ${_substitution_variable} _substitution_variable_upper)
         if (NOT ${_substitution_variable_upper})
-            string(REGEX MATCH "m4_define\\(${_substitution_variable}, \\[(.*)\\]" MACTHED_STRING ${configure_line})
+            string(REGEX MATCH "m4_define\\(${_substitution_variable}, *\\[(.*)\\]" MACTHED_STRING ${configure_line})
             if (CMAKE_MATCH_1)
                 set(${_substitution_variable_upper} ${CMAKE_MATCH_1})
             endif()
@@ -413,6 +413,24 @@
     endforeach()
 endforeach()
 
+set(PACKAGE_VERSION "${PCRE2_MAJOR}.${PCRE2_MINOR}")
+
+string(REPLACE ":" ";" LIBPCRE2_8_VERSION_LIST ${LIBPCRE2_8_VERSION})
+list(GET LIBPCRE2_8_VERSION_LIST 0 LIBPCRE2_8_VERSION_CURRENT)
+list(GET LIBPCRE2_8_VERSION_LIST 1 LIBPCRE2_8_VERSION_REVISION)
+list(GET LIBPCRE2_8_VERSION_LIST 2 LIBPCRE2_8_VERSION_AGE)
+math(EXPR LIBPCRE2_8_SOVERSION "${LIBPCRE2_8_VERSION_CURRENT} - ${LIBPCRE2_8_VERSION_AGE}")
+math(EXPR LIBPCRE2_8_MACHO_VERSION "${LIBPCRE2_8_VERSION_CURRENT} + 1")
+set(LIBPCRE2_8_VERSION "${LIBPCRE2_8_SOVERSION}.${LIBPCRE2_8_VERSION_AGE}.${LIBPCRE2_8_VERSION_REVISION}")
+
+string(REPLACE ":" ";" LIBPCRE2_POSIX_VERSION_LIST ${LIBPCRE2_POSIX_VERSION})
+list(GET LIBPCRE2_POSIX_VERSION_LIST 0 LIBPCRE2_POSIX_VERSION_CURRENT)
+list(GET LIBPCRE2_POSIX_VERSION_LIST 1 LIBPCRE2_POSIX_VERSION_REVISION)
+list(GET LIBPCRE2_POSIX_VERSION_LIST 2 LIBPCRE2_POSIX_VERSION_AGE)
+math(EXPR LIBPCRE2_POSIX_SOVERSION "${LIBPCRE2_POSIX_VERSION_CURRENT} - ${LIBPCRE2_POSIX_VERSION_AGE}")
+math(EXPR LIBPCRE2_POSIX_MACHO_VERSION "${LIBPCRE2_POSIX_VERSION_CURRENT} + 1")
+set(LIBPCRE2_POSIX_VERSION "${LIBPCRE2_POSIX_SOVERSION}.${LIBPCRE2_POSIX_VERSION_AGE}.${LIBPCRE2_POSIX_VERSION_REVISION}")
+
 CONFIGURE_FILE(src/pcre2.h.in
                ${PROJECT_BINARY_DIR}/pcre2.h
                @ONLY)
@@ -540,16 +558,36 @@
 # 8-bit library
 
 IF(PCRE2_BUILD_PCRE2_8)
-ADD_LIBRARY(pcre2-8 ${PCRE2_HEADERS} ${PCRE2_SOURCES} ${PROJECT_BINARY_DIR}/config.h)
-SET_PROPERTY(TARGET pcre2-8
-  PROPERTY COMPILE_DEFINITIONS PCRE2_CODE_UNIT_WIDTH=8)
+  ADD_LIBRARY(pcre2-8 ${PCRE2_HEADERS} ${PCRE2_SOURCES} ${PROJECT_BINARY_DIR}/config.h)
+
+SET_TARGET_PROPERTIES(pcre2-8 PROPERTIES
+  COMPILE_DEFINITIONS PCRE2_CODE_UNIT_WIDTH=8
+  MACHO_COMPATIBILITY_VERSION ${LIBPCRE2_8_MACHO_VERSION}
+  MACHO_CURRENT_VERSION ${LIBPCRE2_8_MACHO_VERSION}
+  VERSION ${LIBPCRE2_8_VERSION}
+  SOVERSION ${LIBPCRE2_8_SOVERSION})
 SET(targets ${targets} pcre2-8)
 ADD_LIBRARY(pcre2-posix ${PCRE2POSIX_HEADERS} ${PCRE2POSIX_SOURCES})
-SET_PROPERTY(TARGET pcre2-posix
-  PROPERTY COMPILE_DEFINITIONS PCRE2_CODE_UNIT_WIDTH=8)
+SET_TARGET_PROPERTIES(pcre2-posix PROPERTIES
+  COMPILE_DEFINITIONS PCRE2_CODE_UNIT_WIDTH=8
+  MACHO_COMPATIBILITY_VERSION ${LIBPCRE2_POSIX_MACHO_VERSION}
+  MACHO_CURRENT_VERSION ${LIBPCRE2_POSIX_MACHO_VERSION}
+  VERSION ${LIBPCRE2_POSIX_VERSION}
+  SOVERSION ${LIBPCRE2_POSIX_SOVERSION})
 SET(targets ${targets} pcre2-posix)
 TARGET_LINK_LIBRARIES(pcre2-posix pcre2-8)
 
+# pkg-config
+SET(prefix ${CMAKE_INSTALL_PREFIX})
+
+SET(exec_prefix "\${prefix}")
+SET(libdir "\${exec_prefix}/lib")
+SET(includedir "\${prefix}/include")
+CONFIGURE_FILE(libpcre2-posix.pc.in libpcre2-posix.pc @ONLY)
+CONFIGURE_FILE(libpcre2-8.pc.in libpcre2-8.pc @ONLY)
+CONFIGURE_FILE(pcre2-config.in pcre2-config @ONLY)
+SET(pkg_config_files ${pkg_config_files} "${CMAKE_CURRENT_BINARY_DIR}/libpcre2-posix.pc" "${CMAKE_CURRENT_BINARY_DIR}/libpcre2-8.pc")
+
 IF(MINGW AND NOT PCRE2_STATIC)
   IF(NON_STANDARD_LIB_PREFIX)
     SET_TARGET_PROPERTIES(pcre2-8 pcre2-posix PROPERTIES PREFIX "")
@@ -756,6 +794,10 @@
         RUNTIME DESTINATION bin
         LIBRARY DESTINATION lib
         ARCHIVE DESTINATION lib)
+INSTALL(FILES ${pkg_config_files} DESTINATION lib/pkgconfig)
+INSTALL(FILES "${CMAKE_CURRENT_BINARY_DIR}/pcre2-config"
+  DESTINATION bin
+  PERMISSIONS OWNER_READ OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE)
 
 INSTALL(FILES ${PCRE2_HEADERS} ${PCRE2POSIX_HEADERS} DESTINATION include)
 
